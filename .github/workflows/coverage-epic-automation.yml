name: "Coverage Epic Automation"

# Coverage Epic Automation Workflow
# Executes 4 times per day (every 6 hours) to generate test coverage improvements
# Each execution creates autonomous AI agent tasks contributing to Epic #94
# Target: 90% backend test coverage by January 2026

on:
  schedule:
    # Run every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      skip_epic_update:
        description: 'Skip epic branch update from develop'
        required: false
        default: false
        type: boolean
      target_area:
        description: 'Optional target area for focused coverage (e.g., "Services", "Controllers")'
        required: false
        default: ''
        type: string

# Prevent multiple concurrent executions to avoid agent conflicts
concurrency:
  group: coverage-epic-automation
  cancel-in-progress: false

env:
  DOTNET_VERSION: '8.0.x'
  EPIC_BRANCH: 'epic/testing-coverage-to-90'
  EPIC_ISSUE_ID: '94'

permissions:
  id-token: write
  contents: write
  actions: read
  pull-requests: write
  issues: write

jobs:
  coverage-epic-agent:
    name: "Coverage Epic AI Agent"
    runs-on: ubuntu-latest
    
    # Only run on main repository, not forks
    if: github.repository == 'Zarichney-Development/zarichney-api'
    
    steps:
      # ========================================
      # Environment Setup
      # ========================================
      
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for branch management
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "Setup Development Environment"
        uses: ./.github/actions/shared/setup-environment
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          setup-node: false
          cache-dependencies: true
      
      - name: "Configure Git for Automation"
        run: |
          git config --global user.name "Coverage Epic Bot"
          git config --global user.email "noreply@zarichney.dev"
          git config --global init.defaultBranch main
      
      # ========================================
      # Epic Branch Management
      # ========================================
      
      - name: "Prepare Epic Branch"
        id: epic-branch
        run: |
          echo "üîÑ Managing epic branch: $EPIC_BRANCH"
          
          # Ensure we start from develop
          git checkout develop || {
            echo "‚ùå Failed to checkout develop branch"
            exit 1
          }
          git pull origin develop
          
          # Create or update epic branch
          if git show-ref --verify --quiet refs/heads/$EPIC_BRANCH; then
            echo "üìù Epic branch exists, updating from develop"
            git checkout $EPIC_BRANCH
            
            if ! ${{ github.event.inputs.skip_epic_update || 'false' }}; then
              # Attempt to merge develop changes
              if git merge develop --no-edit; then
                echo "‚úÖ Epic branch updated successfully"
                git push origin $EPIC_BRANCH
              else
                echo "‚ö†Ô∏è Merge conflicts detected, resetting epic branch"
                git merge --abort
                git reset --hard develop
                git push --force-with-lease origin $EPIC_BRANCH
                echo "üîÑ Epic branch reset to match develop"
              fi
            else
              echo "‚è≠Ô∏è Skipping epic branch update (manual override)"
            fi
          else
            echo "üÜï Creating new epic branch from develop"
            git checkout -b $EPIC_BRANCH
            git push origin $EPIC_BRANCH
          fi
          
          # Set outputs for subsequent steps
          echo "epic_branch_ready=true" >> $GITHUB_OUTPUT
          echo "current_commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      # ========================================
      # Pre-Flight Validation
      # ========================================
      
      - name: "Restore Dependencies"
        run: dotnet restore zarichney-api.sln
      
      - name: "Build Solution"
        run: dotnet build zarichney-api.sln --configuration Release --no-restore
      
      - name: "Validate Test Environment"
        id: test-validation
        run: |
          echo "üß™ Validating CI test environment"
          
          # Execute test suite and capture results
          ./Scripts/run-test-suite.sh report summary > test_summary.txt 2>&1 || {
            echo "‚ùå Test suite execution failed"
            cat test_summary.txt
            exit 1
          }
          
          # Parse test results for validation
          if grep -q "100%" test_summary.txt && grep -q "skipped" test_summary.txt; then
            echo "‚úÖ Test environment validated"
            echo "environment_valid=true" >> $GITHUB_OUTPUT
            
            # Extract metrics for agent coordination
            TOTAL_TESTS=$(grep -o "Total.*tests" test_summary.txt | head -1 || echo "~88 total tests")
            SKIPPED_COUNT=$(grep -o "[0-9]* skipped" test_summary.txt | head -1 || echo "23 skipped")
            
            echo "test_metrics=$TOTAL_TESTS, $SKIPPED_COUNT" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Test environment validation failed"
            cat test_summary.txt
            echo "environment_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      # ========================================
      # Coverage Analysis & Scope Selection
      # ========================================
      
      - name: "Analyze Coverage Gaps"
        id: coverage-analysis
        if: steps.test-validation.outputs.environment_valid == 'true'
        run: |
          echo "üìä Analyzing coverage gaps for scope selection"
          
          # Generate comprehensive coverage report
          ./Scripts/run-test-suite.sh report > coverage_analysis.txt 2>&1
          
          # Extract coverage information
          CURRENT_COVERAGE=$(grep -o "[0-9]*\.[0-9]*%" coverage_analysis.txt | head -1 || echo "Unknown%")
          echo "current_coverage=$CURRENT_COVERAGE" >> $GITHUB_OUTPUT
          
          # Identify target areas (simplified selection for automation)
          TARGET_AREA="${{ github.event.inputs.target_area }}"
          if [ -z "$TARGET_AREA" ]; then
            # Auto-select based on timestamp for agent coordination
            HOUR=$(date +%H)
            case $((HOUR % 4)) in
              0) TARGET_AREA="Services" ;;
              1) TARGET_AREA="Controllers" ;;
              2) TARGET_AREA="Repositories" ;;
              3) TARGET_AREA="Utilities" ;;
            esac
          fi
          
          echo "selected_target_area=$TARGET_AREA" >> $GITHUB_OUTPUT
          echo "üéØ Selected target area: $TARGET_AREA"
          
          # Generate unique task identifier
          TIMESTAMP=$(date +%s)
          TASK_ID="coverage-${TARGET_AREA,,}-${TIMESTAMP}"
          echo "task_identifier=$TASK_ID" >> $GITHUB_OUTPUT
          
          echo "scope_analysis_complete=true" >> $GITHUB_OUTPUT
      
      # ========================================
      # AI Agent Task Execution
      # ========================================
      
      - name: "Create Task Branch"
        id: task-branch
        if: steps.coverage-analysis.outputs.scope_analysis_complete == 'true'
        run: |
          TASK_BRANCH="tests/issue-$EPIC_ISSUE_ID-${{ steps.coverage-analysis.outputs.task_identifier }}"
          echo "task_branch_name=$TASK_BRANCH" >> $GITHUB_OUTPUT
          
          echo "üåø Creating task branch: $TASK_BRANCH"
          git checkout -b "$TASK_BRANCH"
          
          echo "task_branch_created=true" >> $GITHUB_OUTPUT
      
      - name: "Extract Coverage Task Context"
        id: task-context
        if: steps.task-branch.outputs.task_branch_created == 'true'
        run: |
          # Extract context for Claude Code action (using proper escaping)
          echo "task_branch=${{ steps.task-branch.outputs.task_branch_name }}" >> $GITHUB_OUTPUT
          echo "target_area=${{ steps.coverage-analysis.outputs.selected_target_area }}" >> $GITHUB_OUTPUT
          echo "current_coverage=${{ steps.coverage-analysis.outputs.current_coverage }}" >> $GITHUB_OUTPUT
          echo "task_identifier=${{ steps.coverage-analysis.outputs.task_identifier }}" >> $GITHUB_OUTPUT
          echo "epic_issue_id=$EPIC_ISSUE_ID" >> $GITHUB_OUTPUT

      - name: "Check for existing Coverage Epic analysis comment"
        id: check-existing-comment
        if: steps.task-branch.outputs.task_branch_created == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check for existing unresolved Coverage Epic analysis comments in linked issue
            const issueNumber = ${{ env.EPIC_ISSUE_ID }};
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });
            
            // Check for existing active coverage analysis comments
            const hasActiveAnalysis = comments.data.some(comment => {
              const body = comment.body || '';
              return (
                // Contains the Coverage Epic analysis header
                body.includes('## ü§ñ Coverage Epic AI Agent Report') &&
                // Is not an error message
                !body.includes('Claude encountered an error') &&
                !body.includes('Coverage Epic Analysis Failed') &&
                // Contains substantial analysis content
                (body.includes('### üìä Coverage Improvement Analysis') || 
                 body.includes('Coverage Impact:') ||
                 body.includes('Test Methods Added:'))
              );
            });
            
            console.log(`Found existing Coverage Epic analysis: ${hasActiveAnalysis}`);
            core.setOutput('skip_analysis', hasActiveAnalysis.toString());
            
            if (hasActiveAnalysis) {
              console.log('Skipping Coverage Epic analysis - existing active analysis comment found');
            }

      - name: "Load coverage epic prompt"
        if: steps.check-existing-comment.outputs.skip_analysis != 'true'
        id: load-coverage-prompt
        run: |
          # Read the markdown template
          PROMPT_TEMPLATE=$(cat .github/prompts/coverage-epic-agent.md)
          
          # Replace placeholders with actual values
          PROMPT="${PROMPT_TEMPLATE//\{\{COVERAGE_TARGET_AREA\}\}/${{ steps.task-context.outputs.target_area }}}"
          PROMPT="${PROMPT//\{\{CURRENT_COVERAGE\}\}/${{ steps.task-context.outputs.current_coverage }}}"
          PROMPT="${PROMPT//\{\{TASK_IDENTIFIER\}\}/${{ steps.task-context.outputs.task_identifier }}}"
          PROMPT="${PROMPT//\{\{EPIC_ISSUE_ID\}\}/${{ steps.task-context.outputs.epic_issue_id }}}"
          PROMPT="${PROMPT//\{\{TASK_BRANCH\}\}/${{ steps.task-context.outputs.task_branch }}}"
          
          # Output for use in Claude action
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: "Execute Coverage Epic AI Agent"
        if: steps.check-existing-comment.outputs.skip_analysis != 'true'
        id: claude-coverage
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: ${{ steps.load-coverage-prompt.outputs.prompt }}

      - name: "Handle Coverage Epic AI Failure"
        if: failure() && steps.claude-coverage.outcome == 'failure'
        uses: ./.github/actions/handle-ai-analysis-failure
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          analysis-type: 'Coverage Epic Agent'
          analysis-emoji: 'ü§ñ'
          analysis-name: 'Coverage Epic Analysis'
          standards-link: 'https://github.com/Zarichney-Development/zarichney-api/blob/main/Docs/Standards/TestingStandards.md'
          run-number: ${{ github.run_number }}
          run-id: ${{ github.run_id }}

      - name: "Set AI Execution Status"
        id: ai-execution
        if: always() && steps.task-branch.outputs.task_branch_created == 'true'
        run: |
          if [ "${{ steps.check-existing-comment.outputs.skip_analysis }}" = "true" ]; then
            echo "ai_execution_status=skipped_existing_analysis" >> $GITHUB_OUTPUT
            echo "coverage_improvements=Skipped - existing analysis found in Epic Issue #$EPIC_ISSUE_ID" >> $GITHUB_OUTPUT
          elif [ "${{ steps.claude-coverage.outcome }}" = "success" ]; then
            echo "ai_execution_status=claude_success" >> $GITHUB_OUTPUT
            echo "coverage_improvements=Claude AI agent completed coverage improvements successfully" >> $GITHUB_OUTPUT
          elif [ "${{ steps.claude-coverage.outcome }}" = "failure" ]; then
            echo "ai_execution_status=claude_failure" >> $GITHUB_OUTPUT
            echo "coverage_improvements=Claude AI agent encountered an error during execution" >> $GITHUB_OUTPUT
          else
            echo "ai_execution_status=not_executed" >> $GITHUB_OUTPUT
            echo "coverage_improvements=AI agent was not executed" >> $GITHUB_OUTPUT
          fi
      
      # ========================================
      # Quality Gates & Validation
      # ========================================
      
      - name: "Validate Infrastructure & Test Suite"
        id: post-validation
        if: always() && steps.ai-execution.outputs.ai_execution_status != ''
        run: |
          echo "üîç Validating infrastructure and test suite status"
          
          AI_STATUS="${{ steps.ai-execution.outputs.ai_execution_status }}"
          echo "üìã AI Execution Status: $AI_STATUS"
          
          # Build validation to ensure no regressions
          echo "üî® Validating build integrity"
          if dotnet build zarichney-api.sln --configuration Release --no-restore; then
            echo "‚úÖ Build validation passed - no build regressions"
            BUILD_STATUS="passed"
          else
            echo "‚ùå Build validation failed - infrastructure needs attention"
            BUILD_STATUS="failed"
          fi
          
          # Test suite validation (basic health check)
          echo "üß™ Validating test suite health"
          if ./Scripts/run-test-suite.sh report summary > post_test_summary.txt 2>&1; then
            echo "‚úÖ Test suite execution completed"
            
            # Check for expected test patterns
            if grep -q "100%" post_test_summary.txt && grep -q "skipped" post_test_summary.txt; then
              echo "‚úÖ Test suite maintains expected patterns (100% pass rate with skips)"
              TEST_STATUS="healthy"
            else
              echo "‚ö†Ô∏è Test suite patterns may have changed"
              TEST_STATUS="changed"
            fi
            
            # Show summary for transparency
            echo "üìä Test execution summary:"
            grep -E "(passed|failed|skipped|Total)" post_test_summary.txt | head -5 | sed 's/^/  /'
            
          else
            echo "‚ùå Test suite execution failed"
            TEST_STATUS="failed"
            echo "üìã Error details:"
            tail -10 post_test_summary.txt | sed 's/^/  /'
          fi
          
          # Determine overall validation status
          if [ "$BUILD_STATUS" = "passed" ] && [ "$TEST_STATUS" != "failed" ]; then
            if [ "$AI_STATUS" = "claude_success" ]; then
              echo "‚úÖ Infrastructure validation passed - Claude AI agent executed successfully"
              echo "üìà Coverage improvements implemented by autonomous AI agent"
              echo "üöÄ Epic #$EPIC_ISSUE_ID progression: Real AI-powered test generation completed"
              
            elif [ "$AI_STATUS" = "skipped_existing_analysis" ]; then
              echo "‚è≠Ô∏è Infrastructure healthy - AI analysis skipped (existing analysis found)"
              echo "üí° Review existing analysis in Epic Issue #$EPIC_ISSUE_ID"
              
            elif [ "$AI_STATUS" = "claude_failure" ]; then
              echo "‚ö†Ô∏è Infrastructure healthy but Claude AI agent encountered issues"
              echo "üìã Check workflow logs and error handling for details"
              
            else
              echo "‚ö†Ô∏è Infrastructure validation completed with status: $AI_STATUS"
            fi
            
            echo "validation_passed=true" >> $GITHUB_OUTPUT
            echo "infrastructure_status=ready" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Infrastructure validation failed"
            echo "üîß Build Status: $BUILD_STATUS"
            echo "üß™ Test Status: $TEST_STATUS"
            echo "validation_passed=false" >> $GITHUB_OUTPUT
            echo "infrastructure_status=needs_attention" >> $GITHUB_OUTPUT
          fi
          
          # Cleanup
          rm -f post_test_summary.txt
      
      # ========================================
      # Automated Pull Request Creation
      # ========================================
      
      - name: "Commit Coverage Improvements"
        id: commit-changes
        if: steps.post-validation.outputs.validation_passed == 'true'
        run: |
          echo "üíæ Committing coverage improvements"
          
          # Check if there are changes to commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "‚ö†Ô∏è No changes detected - AI agent may not have implemented improvements"
            echo "changes_committed=false" >> $GITHUB_OUTPUT
          else
            # Commit all changes
            git add -A
            git commit -m "test: improve coverage for ${{ steps.coverage-analysis.outputs.selected_target_area }} (#$EPIC_ISSUE_ID)
            
            Automated coverage improvement for Epic #$EPIC_ISSUE_ID
            
            - Target Area: ${{ steps.coverage-analysis.outputs.selected_target_area }}
            - Current Coverage: ${{ steps.coverage-analysis.outputs.current_coverage }}
            - Task ID: ${{ steps.coverage-analysis.outputs.task_identifier }}
            - AI Improvements: ${{ steps.ai-execution.outputs.coverage_improvements }}
            - Environment: CI (23 tests skipped, 100% pass rate maintained)
            
            ü§ñ Generated with Coverage Epic Automation
            Co-Authored-By: Coverage Epic Bot <noreply@zarichney.dev>"
            
            # Push task branch
            git push origin "${{ steps.task-branch.outputs.task_branch_name }}"
            
            echo "changes_committed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: "Create Pull Request"
        id: create-pr
        if: steps.commit-changes.outputs.changes_committed == 'true'
        run: |
          echo "üìù Creating automated pull request"
          
          PR_TITLE="test: improve coverage for ${{ steps.coverage-analysis.outputs.selected_target_area }} (#$EPIC_ISSUE_ID)"
          
          PR_BODY="## Coverage Improvement Summary
          
          **Epic Reference:** [Backend Testing Coverage to 90%](https://github.com/Zarichney-Development/zarichney-api/issues/$EPIC_ISSUE_ID)
          **Target Area:** ${{ steps.coverage-analysis.outputs.selected_target_area }}
          **Current Coverage:** ${{ steps.coverage-analysis.outputs.current_coverage }}
          **Task Identifier:** ${{ steps.coverage-analysis.outputs.task_identifier }}
          
          ### Automated Implementation
          - ü§ñ **Execution Model:** Autonomous AI agent in CI environment
          - üéØ **Scope:** Self-selected based on coverage analysis
          - ‚úÖ **Quality Gates:** 100% pass rate maintained on executable tests
          - üìä **Coverage Phase:** Aligned with current coverage progression strategy
          
          ### Changes Made
          ${{ steps.ai-execution.outputs.coverage_improvements }}
          
          ### Test Environment Validation
          - ‚úÖ **Executable Tests:** 100% pass rate maintained
          - ‚úÖ **Expected Skips:** 23 tests skipped (external dependencies unavailable)
          - ‚úÖ **Build Status:** Clean build with no regressions
          - ‚úÖ **Standards Compliance:** All testing standards followed
          
          ### Epic Progress Contribution
          This automated task contributes to the systematic progression toward 90% backend test coverage by January 2026, maintaining the target velocity of ~2.8% monthly improvement.
          
          ---
          
          ü§ñ **Generated by Coverage Epic Automation**  
          **Execution Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
          **Agent Coordination:** Timestamp-based conflict prevention active  
          **Epic Branch:** \`$EPIC_BRANCH\`"
          
          # Create PR using GitHub CLI
          gh pr create \
            --base "$EPIC_BRANCH" \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --label "ai-task,testing,coverage,epic-subtask,automation" \
            --draft=false
          
          PR_URL=$(gh pr view --json url --jq .url)
          echo "pr_created=true" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Pull request created: $PR_URL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ========================================
      # Execution Summary & Metrics
      # ========================================
      
      - name: "Execution Summary"
        if: always()
        run: |
          echo "=================================================="
          echo "üéØ Coverage Epic Automation Execution Summary"
          echo "=================================================="
          echo "üìÖ Execution Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "üåø Epic Branch: $EPIC_BRANCH"
          echo "üéØ Target Area: ${{ steps.coverage-analysis.outputs.selected_target_area || 'Not determined' }}"
          echo "üìä Current Coverage: ${{ steps.coverage-analysis.outputs.current_coverage || 'Unknown' }}"
          echo "üî¢ Task ID: ${{ steps.coverage-analysis.outputs.task_identifier || 'Not generated' }}"
          echo ""
          echo "üìã Step Results:"
          echo "  Epic Branch Ready: ${{ steps.epic-branch.outputs.epic_branch_ready || 'false' }}"
          echo "  Environment Valid: ${{ steps.test-validation.outputs.environment_valid || 'false' }}"
          echo "  Scope Analysis: ${{ steps.coverage-analysis.outputs.scope_analysis_complete || 'false' }}"
          echo "  Task Branch: ${{ steps.task-branch.outputs.task_branch_created || 'false' }}"
          echo "  AI Execution: ${{ steps.ai-execution.outputs.ai_execution_status || 'not_executed' }}"
          echo "  Post-Validation: ${{ steps.post-validation.outputs.validation_passed || 'false' }}"
          echo "  Changes Committed: ${{ steps.commit-changes.outputs.changes_committed || 'false' }}"
          echo "  PR Created: ${{ steps.create-pr.outputs.pr_created || 'false' }}"
          echo ""
          if [ "${{ steps.create-pr.outputs.pr_created }}" = "true" ]; then
            echo "üéâ SUCCESS: Pull request created successfully"
            echo "üîó PR URL: ${{ steps.create-pr.outputs.pr_url }}"
            echo "üìà Epic #$EPIC_ISSUE_ID progression continues"
          else
            echo "‚ö†Ô∏è INCOMPLETE: Automation did not complete successfully"
            echo "üîç Check individual step outputs for diagnostics"
          fi
          echo "=================================================="
      
      - name: "Cleanup on Failure"
        if: failure()
        run: |
          echo "üßπ Cleaning up after failed execution"
          
          # Remove task branch if created but not successfully used
          if [ "${{ steps.task-branch.outputs.task_branch_created }}" = "true" ] && 
             [ "${{ steps.commit-changes.outputs.changes_committed }}" != "true" ]; then
            TASK_BRANCH="${{ steps.task-branch.outputs.task_branch_name }}"
            echo "üóëÔ∏è Removing unused task branch: $TASK_BRANCH"
            git checkout $EPIC_BRANCH 2>/dev/null || git checkout develop
            git branch -D "$TASK_BRANCH" 2>/dev/null || true
          fi
          
          echo "üîç Failure cleanup completed"