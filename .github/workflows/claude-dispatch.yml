name: Claude Code Dispatch

# IMPORTANT: Do not modify this `on` section!
on:
  repository_dispatch:
    types: [claude-dispatch]

jobs:
  claude-dispatch:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      attestations: write
      checks: write
      contents: write
      deployments: write
      discussions: write
      id-token: write
      issues: write
      packages: write
      pages: write
      pull-requests: write
      security-events: write
      statuses: write
      models: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop

      - name: Setup Development Environment
        uses: ./.github/actions/shared/setup-environment
        with:
          dotnet-version: '8.0.x'
          node-version: '18.x'
          setup-dotnet: 'true'
          setup-node: 'true'
          cache-dependencies: 'true'

      - name: Restore Dependencies
        run: |
          echo "ðŸ“¦ Restoring project dependencies..."
          dotnet restore zarichney-api.sln
          echo "âœ… .NET dependencies restored"
          
          # Also restore frontend dependencies if needed
          if [ -d "Code/Zarichney.Website" ]; then
            cd Code/Zarichney.Website
            npm ci --legacy-peer-deps
            cd ../..
            echo "âœ… Node.js dependencies restored"
          fi

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@eap
        with:
          mode: 'remote-agent'
          claude_env: |
            NODE_ENV: development
            DOTNET_VERSION: 8.0.x
            NODE_VERSION: 18.x
            PROJECT_ROOT: /home/runner/work/zarichney-api/zarichney-api
          allowed_tools: |
            Bash(dotnet build:*)
            Bash(dotnet run:*)
            Bash(dotnet test:*)
            Bash(dotnet format:*)
            Bash(git:*)
            Bash(gh:*)
            Bash(ls:*)
            Bash(pwd:*)
            Bash(find:*)
            Bash(grep:*)
            Bash(cat:*)
            Bash(head:*)
            Bash(tail:*)
            Bash(chmod:*)
            Bash(mkdir:*)
            Bash(cp:*)
            Bash(mv:*)
            Bash(rm:*)
            Bash(./Scripts/*)
