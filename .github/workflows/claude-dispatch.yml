# IMPORTANT: Do not move this file in your repo! Make sure it's located at .github/workflows/claude-dispatch.yml
name: Claude Code Dispatch

# IMPORTANT: Do not modify this `on` section!
on:
  repository_dispatch:
    types: [claude-dispatch]

jobs:
  claude-dispatch:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Development Environment
        uses: ./.github/actions/shared/setup-environment
        with:
          dotnet-version: '8.0.x'
          node-version: '18.x'
          setup-dotnet: 'true'
          setup-node: 'true'
          cache-dependencies: 'true'

      - name: Restore Dependencies
        run: |
          echo "ğŸ“¦ Restoring project dependencies..."
          dotnet restore zarichney-api.sln
          echo "âœ… .NET dependencies restored"
          
          # Also restore frontend dependencies if needed
          if [ -d "Code/Zarichney.Website" ]; then
            cd Code/Zarichney.Website
            npm ci --legacy-peer-deps
            cd ../..
            echo "âœ… Node.js dependencies restored"
          fi

      - name: Generate Initial Test Results
        id: test-baseline
        run: |
          echo "ğŸ§ª Generating test baseline for Claude..."
          
          # Run test suite in summary mode to provide context
          if [ -f "./Scripts/run-test-suite.sh" ]; then
            chmod +x ./Scripts/run-test-suite.sh
            ./Scripts/run-test-suite.sh report summary > test_baseline.txt 2>&1 || true
            
            # Save test baseline for Claude's reference
            if [ -f "test_baseline.txt" ]; then
              echo "test_baseline<<EOF" >> $GITHUB_OUTPUT
              cat test_baseline.txt >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              echo "âœ… Test baseline generated"
            fi
          fi
          
          # Save coverage report path if it exists
          if [ -d "TestResults" ]; then
            echo "test_results_available=true" >> $GITHUB_OUTPUT
          else
            echo "test_results_available=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@eap
        with:
          mode: 'remote-agent'
          
          # Optional: Specify an API key, otherwise we'll use your Claude account automatically
          # anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"

          # Optional: Allow Claude to run specific commands
          allowed_tools: |
            Bash(dotnet build:*)
            Bash(dotnet run:*)
            Bash(dotnet test:*)
            Bash(dotnet format:*)
            Bash(git:*)
            Bash(gh:*)
            Bash(ls:*)
            Bash(pwd:*)
            Bash(find:*)
            Bash(grep:*)
            Bash(cat:*)
            Bash(head:*)
            Bash(tail:*)
            Bash(chmod:*)
            Bash(mkdir:*)
            Bash(cp:*)
            Bash(mv:*)
            Bash(rm:*)
            Bash(./Scripts/*)

          # Custom environment variables for Claude
          claude_env: |
            NODE_ENV: development
            DOTNET_VERSION: 8.0.x
            NODE_VERSION: 18.x
            TEST_RESULTS_AVAILABLE: ${{ steps.test-baseline.outputs.test_results_available }}
            PROJECT_ROOT: /home/runner/work/zarichney-api/zarichney-api
            COVERAGE_THRESHOLD: 16

      - name: Capture Test Results & Coverage
        if: always()
        run: |
          echo "ğŸ“Š Capturing test results and coverage reports..."
          
          # Check if Claude ran tests and generated new results
          if [ -d "TestResults" ]; then
            echo "âœ… Test results found"
            
            # Generate summary if available
            if [ -f "TestResults/parsed_results.json" ]; then
              echo "ğŸ“‹ Test Summary:"
              jq -r '.tests | "Total: \(.total), Passed: \(.passed), Failed: \(.failed), Skipped: \(.skipped)"' TestResults/parsed_results.json 2>/dev/null || echo "Unable to parse test results"
            fi
            
            # Check coverage
            if [ -f "TestResults/coverage_results.json" ]; then
              echo "ğŸ“ˆ Coverage Summary:"
              jq -r '"Line Coverage: \(.line_coverage)%, Branch Coverage: \(.branch_coverage)%"' TestResults/coverage_results.json 2>/dev/null || echo "Unable to parse coverage results"
            fi
          else
            echo "â„¹ï¸ No test results generated during this session"
          fi
          
          # Check for coverage reports
          if [ -d "CoverageReport" ]; then
            echo "âœ… Coverage reports found"
            if [ -f "CoverageReport/index.html" ]; then
              echo "ğŸ“„ HTML coverage report available"
            fi
          fi

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-dispatch-results-${{ github.run_number }}
          path: |
            TestResults/
            CoverageReport/
            test_baseline.txt
          retention-days: 7
        continue-on-error: true
