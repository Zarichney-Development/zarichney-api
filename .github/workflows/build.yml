name: "Build & Test"

on:
  push:
    branches: [main]
    paths:
      - 'Code/**'
      - '.github/scripts/**'
      - '*.sln'
      - '.github/workflows/**'
      - '.github/actions/shared/**'
  pull_request:
    branches: ['**']  # Trigger on ALL branch targets for universal PR support
    paths:
      - 'Code/**'
      - '.github/scripts/**'
      - '*.sln'
      - '.github/workflows/**'
      - '.github/actions/shared/**'
  workflow_dispatch:

# Automatically cancel previous runs when new commits are pushed
# This prevents resource waste from duplicate runs during rapid development
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18.x'

permissions:
  id-token: write
  contents: read
  actions: read
  pull-requests: write
  issues: write
  checks: write
  security-events: write

jobs:
  path-analysis:
    name: "Analyze Changed Paths"
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.check-paths.outputs.backend-changed }}
      frontend-changed: ${{ steps.check-paths.outputs.frontend-changed }}
      docs-only: ${{ steps.check-paths.outputs.docs-only }}
      changed-files: ${{ steps.check-paths.outputs.changed-files }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine base reference
        id: determine-base-ref
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "base-ref=origin/${{ github.event.pull_request.base.ref }}" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_name }}" == "main" ]]; then
            echo "base-ref=HEAD~1" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_name }}" == "develop" ]]; then
            echo "base-ref=origin/main" >> $GITHUB_ENV
          else
            echo "base-ref=origin/main" >> $GITHUB_ENV
          fi

      - name: Check changed paths
        id: check-paths
        uses: ./.github/actions/shared/check-paths
        with:
          base-ref: ${{ env.base-ref }}

      - name: Display path analysis
        run: |
          echo "🔍 Path Analysis Results:"
          echo "  - Backend changed: ${{ steps.check-paths.outputs.backend-changed }}"
          echo "  - Frontend changed: ${{ steps.check-paths.outputs.frontend-changed }}"
          echo "  - Documentation only: ${{ steps.check-paths.outputs.docs-only }}"
          echo "  - Changed components: ${{ steps.check-paths.outputs.changed-files }}"
          echo "  - Test run: End-to-end validation"

  backend-build:
    name: "Backend • Build & Test"
    runs-on: ubuntu-latest
    needs: path-analysis
    if: needs.path-analysis.outputs.backend-changed == 'true'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup development environment
        uses: ./.github/actions/shared/setup-environment
        with:
          setup-dotnet: 'true'
          setup-node: 'false'
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Execute backend build and test
        run: |
          echo "🚀 Running backend build and test pipeline..."
          
          # Set CI environment variables
          export CI_ENVIRONMENT=true
          export QUALITY_GATE_ENABLED=true
          export COVERAGE_THRESHOLD=16
          
          # Determine coverage flexibility based on branch/PR context
          COVERAGE_FLAGS=""
          if [[ "${{ github.head_ref }}" == test/* ]] || [[ "${{ github.ref_name }}" == test/* ]]; then
            echo "🧪 Test branch detected - enabling coverage flexibility"
            COVERAGE_FLAGS="--allow-low-coverage"
            export COVERAGE_FLEXIBLE=true
          elif [[ "${{ github.ref_name }}" == "develop" ]] || [[ "${{ github.base_ref }}" == "develop" ]]; then
            echo "🔧 Infrastructure validation on develop branch - enabling coverage flexibility"
            COVERAGE_FLAGS="--allow-low-coverage"
            export COVERAGE_FLEXIBLE=true
          elif [[ "${{ github.event_name }}" == "pull_request" ]] && [[ "${{ contains(github.event.pull_request.labels.*.name, 'low-coverage-allowed') }}" == "true" ]]; then
            echo "🏷️ low-coverage-allowed label detected - enabling coverage flexibility"
            COVERAGE_FLAGS="--allow-low-coverage"
            export COVERAGE_FLEXIBLE=true
          fi
          
          # Execute the pipeline script (disable parallel for accurate coverage collection)
          ./.github/scripts/build-backend.sh --threshold 16 $COVERAGE_FLAGS
        
      - name: Upload backend artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-build-${{ github.run_number }}
          path: artifacts/backend/
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            TestResults/
            CoverageReport/
          retention-days: 7

  claude-testing-analysis:
    name: "Quality Analysis • Testing Analysis (AI)"
    runs-on: ubuntu-latest
    needs: [path-analysis, backend-build, frontend-build, build-summary]
    if: always() && !cancelled() && github.event_name == 'pull_request' && contains(fromJSON('["main", "develop"]'), github.event.pull_request.base.ref) && (needs.build-summary.result == 'success' || needs.path-analysis.outputs.docs-only == 'true')
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract PR Context
        id: pr-context
        run: |
          # Extract issue numbers from PR body
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | grep -oE '[0-9]+' | head -1 || echo "")
          
          if [ -n "$ISSUE_NUMBERS" ]; then
            echo "issue_ref=#$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
          else
            echo "issue_ref=No linked issue" >> $GITHUB_OUTPUT
          fi
          
          # Output PR context
          echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "source_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "target_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT

      - name: Download test results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: test-results-${{ github.run_number }}
          path: ./

      - name: Load testing analysis prompt
        id: load-testing-prompt
        run: |
          # Read the markdown template
          PROMPT_TEMPLATE=$(cat .github/prompts/testing-analysis.md)
          
          # Replace placeholders with actual values
          PROMPT="${PROMPT_TEMPLATE//\{\{PR_NUMBER\}\}/${{ github.event.number }}}"
          PROMPT="${PROMPT//\{\{PR_AUTHOR\}\}/${{ github.event.pull_request.user.login }}}"
          PROMPT="${PROMPT//\{\{ISSUE_REF\}\}/${{ steps.pr-context.outputs.issue_ref }}}"
          PROMPT="${PROMPT//\{\{SOURCE_BRANCH\}\}/${{ github.event.pull_request.head.ref }}}"
          PROMPT="${PROMPT//\{\{TARGET_BRANCH\}\}/${{ github.event.pull_request.base.ref }}}"
          
          # Output for use in Claude action
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Testing Analysis with Claude AI
        id: claude-testing
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: ${{ steps.load-testing-prompt.outputs.prompt }}

      - name: Handle Claude AI Failure
        if: failure() && steps.claude-testing.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Check if this was a Claude usage limit failure
            let isUsageLimitFailure = false;
            try {
              const logFiles = [
                '/home/runner/work/_temp/claude-execution-output.json',
                '/tmp/claude-error.log'
              ];
              
              for (const logFile of logFiles) {
                if (fs.existsSync(logFile)) {
                  const content = fs.readFileSync(logFile, 'utf8');
                  if (content.includes('Claude AI usage limit reached') || content.includes('usage limit')) {
                    isUsageLimitFailure = true;
                    break;
                  }
                }
              }
            } catch (error) {
              console.log('Could not read Claude output files:', error.message);
            }
            
            // Find existing Claude comment to update
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Look for Claude TestMaster error comment that needs updating (contains "Claude encountered an error")
            const claudeComments = comments.data.filter(comment => 
              comment.body && 
              comment.body.includes('Claude encountered an error') &&
              (
                // Either already has TestMaster-specific content
                (
                  comment.body.includes('TestMaster') ||
                  comment.body.includes('Testing Analysis') ||
                  comment.body.includes('🧪 TestMaster')
                ) ||
                // Or is a generic error comment that hasn't been updated yet
                (
                  comment.body.includes('I\'ll analyze this and get back to you') &&
                  !comment.body.includes('StandardsGuardian') &&
                  !comment.body.includes('DebtSentinel') &&
                  !comment.body.includes('SecuritySentinel') &&
                  !comment.body.includes('MergeOrchestrator')
                )
              )
            );
            // Get the most recent Claude error comment for TestMaster
            const claudeComment = claudeComments.length > 0 ? claudeComments[claudeComments.length - 1] : null;
            
            const failureCommentBody = isUsageLimitFailure ? 
              `## 🚫 TestMaster Analysis Failed - Usage Limit Reached
              
              **Analysis Status:** ❌ **FAILED**
              
              The Testing Analysis could not be completed due to Claude AI usage limit being reached. This is a temporary issue that will resolve when the usage limit resets.
              
              **Impact:**
              - This PR cannot receive automated testing quality analysis at this time
              - Manual review is recommended for testing standards compliance
              - All other pipeline checks (build, tests, security) continue normally
              
              **Next Steps:**
              - Wait for Claude usage limit to reset (typically resets daily)
              - Re-run the workflow or push a new commit to retry analysis
              - Consider manual testing review against [Testing Standards](https://github.com/Zarichney-Development/zarichney-api/blob/main/Docs/Standards/TestingStandards.md)
              
              **Workflow Status:** This failure will block the pipeline to ensure proper quality gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*` :
              `## 🚫 TestMaster Analysis Failed - Technical Error
              
              **Analysis Status:** ❌ **FAILED**
              
              The Testing Analysis encountered a technical error and could not be completed.
              
              **Impact:**
              - This PR cannot receive automated testing quality analysis at this time
              - Manual review is recommended for testing standards compliance
              - All other pipeline checks (build, tests, security) continue normally
              
              **Next Steps:**
              - Check workflow logs for specific error details
              - Re-run the workflow to retry analysis
              - Consider manual testing review against [Testing Standards](https://github.com/Zarichney-Development/zarichney-api/blob/main/Docs/Standards/TestingStandards.md)
              
              **Workflow Status:** This failure will block the pipeline to ensure proper quality gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            if (claudeComment) {
              // Update existing Claude comment
              console.log(`Updating existing Claude comment ID: ${claudeComment.id}`);
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: claudeComment.id,
                body: failureCommentBody
              });
            } else {
              // Fallback: create new comment if Claude comment not found
              console.log('Claude comment not found, creating new comment');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: failureCommentBody
              });
            }
            
            // Fail the workflow step to make the failure visible
            core.setFailed(isUsageLimitFailure ? 
              'TestMaster analysis failed due to Claude AI usage limit' : 
              'TestMaster analysis failed due to technical error');

  frontend-build:
    name: "Frontend • Build & Test"
    runs-on: ubuntu-latest
    needs: path-analysis
    if: needs.path-analysis.outputs.frontend-changed == 'true'
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup development environment
        uses: ./.github/actions/shared/setup-environment
        with:
          setup-dotnet: 'false'
          setup-node: 'true'
          node-version: ${{ env.NODE_VERSION }}

      - name: Execute frontend build and test
        run: |
          echo "🚀 Running frontend build and test pipeline..."
          
          # Set CI environment variables
          export CI_ENVIRONMENT=true
          
          # Execute the pipeline script
          ./.github/scripts/build-frontend.sh --prod
        
      - name: Upload frontend artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.run_number }}
          path: artifacts/frontend/
          retention-days: 7

  build-summary:
    name: "Build Summary"
    runs-on: ubuntu-latest
    needs: [path-analysis, backend-build, frontend-build]
    if: always() && !cancelled()
    
    steps:
      - name: Generate build summary
        run: |
          echo "📊 Build Pipeline Summary"
          echo "========================"
          echo ""
          echo "**Path Analysis:**"
          echo "  - Backend changed: ${{ needs.path-analysis.outputs.backend-changed }}"
          echo "  - Frontend changed: ${{ needs.path-analysis.outputs.frontend-changed }}"
          echo "  - Documentation only: ${{ needs.path-analysis.outputs.docs-only }}"
          echo "  - Components: ${{ needs.path-analysis.outputs.changed-files }}"
          echo ""
          echo "**Build Results:**"
          echo "  - Backend build: ${{ needs.backend-build.result || 'skipped' }}"
          echo "  - Frontend build: ${{ needs.frontend-build.result || 'skipped' }}"
          echo ""
          
          # Check for failures
          if [ "${{ needs.backend-build.result }}" = "failure" ] || [ "${{ needs.frontend-build.result }}" = "failure" ]; then
            echo "❌ One or more builds failed"
            exit 1
          elif [ "${{ needs.path-analysis.outputs.docs-only }}" = "true" ]; then
            echo "📚 Only documentation changed - no builds required"
          else
            echo "✅ All required builds completed successfully"
          fi


  claude-standards-analysis:
    name: "Quality Analysis • Standards Compliance (AI)"
    runs-on: ubuntu-latest
    needs: [path-analysis, backend-build, frontend-build, build-summary]
    if: always() && !cancelled() && github.event_name == 'pull_request' && contains(fromJSON('["main", "develop"]'), github.event.pull_request.base.ref) && (needs.build-summary.result == 'success' || needs.path-analysis.outputs.docs-only == 'true')
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract PR Context
        id: pr-context
        run: |
          # Extract issue numbers from PR body
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | grep -oE '[0-9]+' | head -1 || echo "")
          
          if [ -n "$ISSUE_NUMBERS" ]; then
            echo "issue_ref=#$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
          else
            echo "issue_ref=No linked issue" >> $GITHUB_OUTPUT
          fi
          
          # Output PR context
          echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "source_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "target_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT

      - name: Load standards compliance prompt
        id: load-standards-prompt
        run: |
          # Read the markdown template
          PROMPT_TEMPLATE=$(cat .github/prompts/standards-compliance.md)
          
          # Replace placeholders with actual values
          PROMPT="${PROMPT_TEMPLATE//\{\{PR_NUMBER\}\}/${{ github.event.number }}}"
          PROMPT="${PROMPT//\{\{PR_AUTHOR\}\}/${{ github.event.pull_request.user.login }}}"
          PROMPT="${PROMPT//\{\{ISSUE_REF\}\}/${{ steps.pr-context.outputs.issue_ref }}}"
          PROMPT="${PROMPT//\{\{SOURCE_BRANCH\}\}/${{ github.event.pull_request.head.ref }}}"
          PROMPT="${PROMPT//\{\{TARGET_BRANCH\}\}/${{ github.event.pull_request.base.ref }}}"
          
          # Output for use in Claude action
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Standards Compliance AI Analysis
        id: claude-standards
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: ${{ steps.load-standards-prompt.outputs.prompt }}

      - name: Handle Standards Analysis Failure
        if: failure() && steps.claude-standards.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Check if this was a Claude usage limit failure
            let isUsageLimitFailure = false;
            try {
              const logFiles = [
                '/home/runner/work/_temp/claude-execution-output.json',
                '/tmp/claude-error.log'
              ];
              
              for (const logFile of logFiles) {
                if (fs.existsSync(logFile)) {
                  const content = fs.readFileSync(logFile, 'utf8');
                  if (content.includes('Claude AI usage limit reached') || content.includes('usage limit')) {
                    isUsageLimitFailure = true;
                    break;
                  }
                }
              }
            } catch (error) {
              console.log('Could not read Claude output files:', error.message);
            }
            
            // Find existing Claude comment to update
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Look for Claude StandardsGuardian error comment that needs updating (contains "Claude encountered an error")
            const claudeComments = comments.data.filter(comment => 
              comment.body && 
              comment.body.includes('Claude encountered an error') &&
              (
                // Either already has StandardsGuardian-specific content
                (
                  comment.body.includes('StandardsGuardian') ||
                  comment.body.includes('Standards Compliance') ||
                  comment.body.includes('🛡️ StandardsGuardian')
                ) ||
                // Or is a generic error comment that hasn't been updated yet
                (
                  comment.body.includes('I\'ll analyze this and get back to you') &&
                  !comment.body.includes('TestMaster') &&
                  !comment.body.includes('DebtSentinel') &&
                  !comment.body.includes('SecuritySentinel') &&
                  !comment.body.includes('MergeOrchestrator')
                )
              )
            );
            // Get the most recent Claude error comment for StandardsGuardian
            const claudeComment = claudeComments.length > 0 ? claudeComments[claudeComments.length - 1] : null;
            
            const failureCommentBody = isUsageLimitFailure ? 
              `## 🚫 StandardsGuardian Analysis Failed - Usage Limit Reached
              
              **Analysis Status:** ❌ **FAILED**
              
              The Standards Compliance Analysis could not be completed due to Claude AI usage limit being reached.
              
              **Impact:**
              - This PR cannot receive automated standards compliance analysis at this time
              - Manual review is recommended against [Coding Standards](https://github.com/Zarichney-Development/zarichney-api/blob/main/Docs/Standards/CodingStandards.md)
              - All other pipeline checks (build, tests, security) continue normally
              
              **Next Steps:**
              - Wait for Claude usage limit to reset (typically resets daily)
              - Re-run the workflow or push a new commit to retry analysis
              - Consider manual standards review
              
              **Workflow Status:** This failure will block the pipeline to ensure proper quality gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*` :
              `## 🚫 StandardsGuardian Analysis Failed - Technical Error
              
              **Analysis Status:** ❌ **FAILED**
              
              The Standards Compliance Analysis encountered a technical error and could not be completed.
              
              **Impact:**
              - This PR cannot receive automated standards compliance analysis at this time
              - Manual review is recommended against [Coding Standards](https://github.com/Zarichney-Development/zarichney-api/blob/main/Docs/Standards/CodingStandards.md)
              
              **Next Steps:**
              - Check workflow logs for specific error details
              - Re-run the workflow to retry analysis
              
              **Workflow Status:** This failure will block the pipeline to ensure proper quality gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            if (claudeComment) {
              // Update existing Claude comment
              console.log(`Updating existing Claude comment ID: ${claudeComment.id}`);
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: claudeComment.id,
                body: failureCommentBody
              });
            } else {
              // Fallback: create new comment if Claude comment not found
              console.log('Claude comment not found, creating new comment');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: failureCommentBody
              });
            }
            
            core.setFailed(isUsageLimitFailure ? 
              'StandardsGuardian analysis failed due to Claude AI usage limit' : 
              'StandardsGuardian analysis failed due to technical error');

  claude-tech-debt-analysis:
    name: "Quality Analysis • Tech Debt Analysis (AI)"
    runs-on: ubuntu-latest
    needs: [path-analysis, backend-build, frontend-build, build-summary]
    if: always() && !cancelled() && github.event_name == 'pull_request' && contains(fromJSON('["main", "develop"]'), github.event.pull_request.base.ref) && (needs.build-summary.result == 'success' || needs.path-analysis.outputs.docs-only == 'true')
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract PR Context
        id: pr-context
        run: |
          # Extract issue numbers from PR body
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | grep -oE '[0-9]+' | head -1 || echo "")
          
          if [ -n "$ISSUE_NUMBERS" ]; then
            echo "issue_ref=#$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
          else
            echo "issue_ref=No linked issue" >> $GITHUB_OUTPUT
          fi
          
          # Output PR context
          echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "source_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "target_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT

      - name: Load tech debt analysis prompt
        id: load-techdebt-prompt
        run: |
          # Read the markdown template
          PROMPT_TEMPLATE=$(cat .github/prompts/tech-debt-analysis.md)
          
          # Replace placeholders with actual values
          PROMPT="${PROMPT_TEMPLATE//\{\{PR_NUMBER\}\}/${{ github.event.number }}}"
          PROMPT="${PROMPT//\{\{PR_AUTHOR\}\}/${{ github.event.pull_request.user.login }}}"
          PROMPT="${PROMPT//\{\{ISSUE_REF\}\}/${{ steps.pr-context.outputs.issue_ref }}}"
          PROMPT="${PROMPT//\{\{SOURCE_BRANCH\}\}/${{ github.event.pull_request.head.ref }}}"
          PROMPT="${PROMPT//\{\{TARGET_BRANCH\}\}/${{ github.event.pull_request.base.ref }}}"
          
          # Output for use in Claude action
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Tech Debt AI Analysis
        id: claude-techdebt
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: ${{ steps.load-techdebt-prompt.outputs.prompt }}

      - name: Handle Tech Debt Analysis Failure
        if: failure() && steps.claude-techdebt.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Check if this was a Claude usage limit failure
            let isUsageLimitFailure = false;
            try {
              const logFiles = [
                '/home/runner/work/_temp/claude-execution-output.json',
                '/tmp/claude-error.log'
              ];
              
              for (const logFile of logFiles) {
                if (fs.existsSync(logFile)) {
                  const content = fs.readFileSync(logFile, 'utf8');
                  if (content.includes('Claude AI usage limit reached') || content.includes('usage limit')) {
                    isUsageLimitFailure = true;
                    break;
                  }
                }
              }
            } catch (error) {
              console.log('Could not read Claude output files:', error.message);
            }
            
            // Find existing Claude comment to update
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Look for Claude DebtSentinel error comment that needs updating (contains "Claude encountered an error")
            const claudeComments = comments.data.filter(comment => 
              comment.body && 
              comment.body.includes('Claude encountered an error') &&
              (
                // Either already has DebtSentinel-specific content
                (
                  comment.body.includes('DebtSentinel') ||
                  comment.body.includes('Technical Debt Analysis') ||
                  comment.body.includes('Tech Debt') ||
                  comment.body.includes('🔍 DebtSentinel')
                ) ||
                // Or is a generic error comment that hasn't been updated yet
                (
                  comment.body.includes('I\'ll analyze this and get back to you') &&
                  !comment.body.includes('TestMaster') &&
                  !comment.body.includes('StandardsGuardian') &&
                  !comment.body.includes('SecuritySentinel') &&
                  !comment.body.includes('MergeOrchestrator')
                )
              )
            );
            // Get the most recent Claude error comment for DebtSentinel
            const claudeComment = claudeComments.length > 0 ? claudeComments[claudeComments.length - 1] : null;
            
            const failureCommentBody = isUsageLimitFailure ? 
              `## 🚫 DebtSentinel Analysis Failed - Usage Limit Reached
              
              **Analysis Status:** ❌ **FAILED**
              
              The Technical Debt Analysis could not be completed due to Claude AI usage limit being reached.
              
              **Impact:**
              - This PR cannot receive automated technical debt analysis at this time
              - Manual review is recommended for code quality and maintainability
              - All other pipeline checks (build, tests, security) continue normally
              
              **Next Steps:**
              - Wait for Claude usage limit to reset (typically resets daily)
              - Re-run the workflow or push a new commit to retry analysis
              - Consider manual code quality review
              
              **Workflow Status:** This failure will block the pipeline to ensure proper quality gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*` :
              `## 🚫 DebtSentinel Analysis Failed - Technical Error
              
              **Analysis Status:** ❌ **FAILED**
              
              The Technical Debt Analysis encountered a technical error and could not be completed.
              
              **Impact:**
              - This PR cannot receive automated technical debt analysis at this time
              - Manual review is recommended for code quality and maintainability
              
              **Next Steps:**
              - Check workflow logs for specific error details
              - Re-run the workflow to retry analysis
              
              **Workflow Status:** This failure will block the pipeline to ensure proper quality gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            if (claudeComment) {
              // Update existing Claude comment
              console.log(`Updating existing Claude comment ID: ${claudeComment.id}`);
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: claudeComment.id,
                body: failureCommentBody
              });
            } else {
              // Fallback: create new comment if Claude comment not found
              console.log('Claude comment not found, creating new comment');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: failureCommentBody
              });
            }
            
            core.setFailed(isUsageLimitFailure ? 
              'DebtSentinel analysis failed due to Claude AI usage limit' : 
              'DebtSentinel analysis failed due to technical error');

  security-scans:
    name: "Security • Comprehensive Scanning"
    runs-on: ubuntu-latest
    needs: [path-analysis, backend-build, frontend-build, build-summary]
    if: always() && !cancelled() && github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main' && (needs.build-summary.result == 'success' || needs.path-analysis.outputs.docs-only == 'true')
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        scan-type: ['codeql', 'dependencies', 'secrets', 'policy']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup development environment
        if: matrix.scan-type == 'dependencies'
        uses: ./.github/actions/shared/setup-environment
        with:
          setup-dotnet: 'true'
          setup-node: 'true'
          dotnet-version: '8.0.x'
          node-version: '18.x'

      - name: Initialize CodeQL
        if: matrix.scan-type == 'codeql'
        uses: github/codeql-action/init@v2
        with:
          languages: 'csharp,javascript'
          config-file: ./.github/codeql/codeql-config.yml
          queries: security-extended,security-and-quality

      - name: Build for CodeQL
        if: matrix.scan-type == 'codeql'
        run: |
          # Build backend for CodeQL analysis
          dotnet restore zarichney-api.sln
          dotnet build zarichney-api.sln --configuration Release --no-restore
          
          # Build frontend for CodeQL analysis
          cd Code/Zarichney.Website
          npm ci --legacy-peer-deps
          npm run build-prod

      - name: Perform CodeQL Analysis
        if: matrix.scan-type == 'codeql'
        uses: github/codeql-action/analyze@v2

      - name: Install required tools
        run: |
          echo "📦 Installing required tools for security scanning..."
          sudo apt-get update -qq
          sudo apt-get install -y jq

      - name: Run security scans
        run: |
          echo "🔒 Running security scanning pipeline..."
          echo "📊 Scan Type: ${{ matrix.scan-type }}"
          
          # Set environment variables
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          export HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          # Make scripts executable
          chmod +x ./.github/scripts/run-security-scans.sh
          chmod +x ./.github/scripts/*.sh
          
          # Execute security scanning based on matrix type
          case "${{ matrix.scan-type }}" in
            "codeql")
              echo "CodeQL analysis handled by GitHub Actions"
              echo "✅ CodeQL analysis completed successfully"
              exit 0
              ;;
            "dependencies")
              echo "🔍 Running dependency security scanning..."
              if ./.github/scripts/run-security-scans.sh --deps-only --skip-analysis; then
                echo "✅ Dependency scanning completed successfully"
              else
                echo "❌ Dependency scanning failed"
                exit 1
              fi
              ;;
            "secrets")
              echo "🔐 Running secrets detection scanning..."
              if ./.github/scripts/run-security-scans.sh --secrets-only --skip-analysis; then
                echo "✅ Secrets scanning completed successfully"
              else
                echo "❌ Secrets scanning failed"
                exit 1
              fi
              ;;
            "policy")
              echo "📋 Running policy compliance checks..."
              if ./.github/scripts/run-security-scans.sh --policy-only --skip-analysis; then
                echo "✅ Policy compliance checks completed successfully"
              else
                echo "❌ Policy compliance checks failed"
                exit 1
              fi
              ;;
            *)
              echo "❌ Unknown scan type: ${{ matrix.scan-type }}"
              exit 1
              ;;
          esac

      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-${{ matrix.scan-type }}-${{ github.run_number }}
          path: |
            security-analysis/
            artifacts/security/
          retention-days: 90

  claude-security-analysis:
    name: "Security • AI Analysis"
    runs-on: ubuntu-latest  
    needs: [path-analysis, backend-build, frontend-build, build-summary, security-scans]
    if: always() && !cancelled() && github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main' && (needs.build-summary.result == 'success' || needs.path-analysis.outputs.docs-only == 'true')
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract PR Context
        id: pr-context
        run: |
          # Extract issue numbers from PR body
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | grep -oE '[0-9]+' | head -1 || echo "")
          
          if [ -n "$ISSUE_NUMBERS" ]; then
            echo "issue_ref=#$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
          else
            echo "issue_ref=No linked issue" >> $GITHUB_OUTPUT
          fi
          
          # Output PR context
          echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "source_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "target_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT

      - name: Download all security scan results
        uses: actions/download-artifact@v4
        with:
          pattern: security-scan-*-${{ github.run_number }}
          path: security-results/
          merge-multiple: true

      - name: Create PR check run
        id: create-check
        run: |
          CHECK_RUN_ID=$(gh api repos/${{ github.repository }}/check-runs \
            --method POST \
            --field name="Security Analysis" \
            --field head_sha="${{ github.event.pull_request.head.sha }}" \
            --field status="in_progress" \
            --field details_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --jq '.id')
          echo "check_run_id=$CHECK_RUN_ID" >> $GITHUB_OUTPUT
          echo "Created check run ID: $CHECK_RUN_ID"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Load security analysis prompt
        id: load-security-prompt
        run: |
          # Read the markdown template
          PROMPT_TEMPLATE=$(cat .github/prompts/security-analysis.md)
          
          # Replace placeholders with actual values
          PROMPT="${PROMPT_TEMPLATE//\{\{PR_NUMBER\}\}/${{ github.event.number }}}"
          PROMPT="${PROMPT//\{\{PR_AUTHOR\}\}/${{ github.event.pull_request.user.login }}}"
          PROMPT="${PROMPT//\{\{ISSUE_REF\}\}/${{ steps.pr-context.outputs.issue_ref }}}"
          PROMPT="${PROMPT//\{\{SOURCE_BRANCH\}\}/${{ github.event.pull_request.head.ref }}}"
          PROMPT="${PROMPT//\{\{TARGET_BRANCH\}\}/${{ github.event.pull_request.base.ref }}}"
          
          # Output for use in Claude action
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Security Analysis with Claude AI
        id: claude-security
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: ${{ steps.load-security-prompt.outputs.prompt }}

      - name: Handle Security Analysis Failure
        if: failure() && steps.claude-security.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Check if this was a Claude usage limit failure
            let isUsageLimitFailure = false;
            try {
              const logFiles = [
                '/home/runner/work/_temp/claude-execution-output.json',
                '/tmp/claude-error.log'
              ];
              
              for (const logFile of logFiles) {
                if (fs.existsSync(logFile)) {
                  const content = fs.readFileSync(logFile, 'utf8');
                  if (content.includes('Claude AI usage limit reached') || content.includes('usage limit')) {
                    isUsageLimitFailure = true;
                    break;
                  }
                }
              }
            } catch (error) {
              console.log('Could not read Claude output files:', error.message);
            }
            
            // Find existing Claude comment to update
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Look for Claude SecuritySentinel error comment that needs updating (contains "Claude encountered an error")
            const claudeComments = comments.data.filter(comment => 
              comment.body && 
              comment.body.includes('Claude encountered an error') &&
              (
                // Either already has SecuritySentinel-specific content
                (
                  comment.body.includes('SecuritySentinel') ||
                  comment.body.includes('Security Analysis') ||
                  comment.body.includes('🔍 SecuritySentinel')
                ) ||
                // Or is a generic error comment that hasn't been updated yet
                (
                  comment.body.includes('I\'ll analyze this and get back to you') &&
                  !comment.body.includes('TestMaster') &&
                  !comment.body.includes('StandardsGuardian') &&
                  !comment.body.includes('DebtSentinel') &&
                  !comment.body.includes('MergeOrchestrator')
                )
              )
            );
            // Get the most recent Claude error comment for SecuritySentinel
            const claudeComment = claudeComments.length > 0 ? claudeComments[claudeComments.length - 1] : null;
            
            const failureCommentBody = isUsageLimitFailure ? 
              `## 🚫 SecuritySentinel Analysis Failed - Usage Limit Reached
              
              **Analysis Status:** ❌ **FAILED**
              
              The Security Analysis could not be completed due to Claude AI usage limit being reached.
              
              **Impact:**
              - This PR cannot receive automated security analysis at this time
              - Manual security review is **REQUIRED** for main branch merges
              - All automated security scans (CodeQL, dependency scanning, secrets detection) continue normally
              
              **Next Steps:**
              - Wait for Claude usage limit to reset (typically resets daily)
              - Re-run the workflow or push a new commit to retry analysis
              - **IMPORTANT**: Manual security review is mandatory for production deployments
              
              **Workflow Status:** This failure will block the pipeline to ensure proper security gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*` :
              `## 🚫 SecuritySentinel Analysis Failed - Technical Error
              
              **Analysis Status:** ❌ **FAILED**
              
              The Security Analysis encountered a technical error and could not be completed.
              
              **Impact:**
              - This PR cannot receive automated security analysis at this time
              - Manual security review is **REQUIRED** for main branch merges
              
              **Next Steps:**
              - Check workflow logs for specific error details
              - Re-run the workflow to retry analysis
              - **IMPORTANT**: Manual security review is mandatory
              
              **Workflow Status:** This failure will block the pipeline to ensure proper security gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            if (claudeComment) {
              // Update existing Claude comment
              console.log(`Updating existing Claude comment ID: ${claudeComment.id}`);
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: claudeComment.id,
                body: failureCommentBody
              });
            } else {
              // Fallback: create new comment if Claude comment not found
              console.log('Claude comment not found, creating new comment');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: failureCommentBody
              });
            }
            
            core.setFailed(isUsageLimitFailure ? 
              'SecuritySentinel analysis failed due to Claude AI usage limit' : 
              'SecuritySentinel analysis failed due to technical error');

      - name: Complete PR check run
        if: always() && steps.create-check.outputs.check_run_id != ''
        run: |
          # Determine security status based on scan results
          if [ "${{ job.status }}" = "success" ]; then
            CONCLUSION="success"
            TITLE="✅ Security Analysis: No Critical Issues"
            SUMMARY="Security analysis completed successfully. Check PR comments for detailed findings."
          elif [ "${{ job.status }}" = "failure" ]; then
            CONCLUSION="failure"
            TITLE="❌ Security Analysis: Critical Issues Found"
            SUMMARY="Critical security vulnerabilities detected - review required before deployment"
          else
            CONCLUSION="neutral"
            TITLE="🔒 Security Analysis: Completed"
            SUMMARY="Security analysis completed. Review findings in PR comments."
          fi
          
          gh api repos/${{ github.repository }}/check-runs/${{ steps.create-check.outputs.check_run_id }} \
            --method PATCH \
            --field status="completed" \
            --field conclusion="$CONCLUSION" \
            --field output[title]="$TITLE" \
            --field output[summary]="$SUMMARY"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload security analysis artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-analysis-${{ github.run_number }}
          path: security-results/
          retention-days: 90

  claude-merge-orchestrator:
    name: "Final Analysis • Merge Orchestrator (AI)"
    runs-on: ubuntu-latest
    needs: [path-analysis, backend-build, frontend-build, build-summary, claude-testing-analysis, claude-standards-analysis, claude-tech-debt-analysis, security-scans, claude-security-analysis]
    if: always() && !cancelled() && github.event_name == 'pull_request' && contains(fromJSON('["main", "develop"]'), github.event.pull_request.base.ref) && (needs.build-summary.result == 'success' || needs.path-analysis.outputs.docs-only == 'true')
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract PR Context
        id: pr-context
        run: |
          # Extract issue numbers from PR body
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUMBERS=$(echo "$PR_BODY" | grep -oE '#[0-9]+' | grep -oE '[0-9]+' | head -1 || echo "")
          
          if [ -n "$ISSUE_NUMBERS" ]; then
            echo "issue_ref=#$ISSUE_NUMBERS" >> $GITHUB_OUTPUT
          else
            echo "issue_ref=No linked issue" >> $GITHUB_OUTPUT
          fi
          
          # Output PR context
          echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "pr_author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "source_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "target_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT

      - name: Load merge orchestrator prompt
        id: load-orchestrator-prompt
        run: |
          # Read the markdown template
          PROMPT_TEMPLATE=$(cat .github/prompts/merge-orchestrator-analysis.md)
          
          # Replace placeholders with actual values
          PROMPT="${PROMPT_TEMPLATE//\\{\\{PR_NUMBER\\}\\}/${{ github.event.number }}}"
          PROMPT="${PROMPT//\\{\\{PR_AUTHOR\\}\\}/${{ github.event.pull_request.user.login }}}"
          PROMPT="${PROMPT//\\{\\{ISSUE_REF\\}\\}/${{ steps.pr-context.outputs.issue_ref }}}"
          PROMPT="${PROMPT//\\{\\{SOURCE_BRANCH\\}\\}/${{ github.event.pull_request.head.ref }}}"
          PROMPT="${PROMPT//\\{\\{TARGET_BRANCH\\}\\}/${{ github.event.pull_request.base.ref }}}"
          
          # Output for use in Claude action
          echo "prompt<<EOF" >> $GITHUB_OUTPUT
          echo "$PROMPT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Merge Orchestrator AI Analysis
        id: claude-orchestrator
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: ${{ steps.load-orchestrator-prompt.outputs.prompt }}

      - name: Handle Merge Orchestrator Failure
        if: failure() && steps.claude-orchestrator.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Check if this was a Claude usage limit failure
            let isUsageLimitFailure = false;
            try {
              const logFiles = [
                '/home/runner/work/_temp/claude-execution-output.json',
                '/tmp/claude-error.log'
              ];
              
              for (const logFile of logFiles) {
                if (fs.existsSync(logFile)) {
                  const content = fs.readFileSync(logFile, 'utf8');
                  if (content.includes('Claude AI usage limit reached') || content.includes('usage limit')) {
                    isUsageLimitFailure = true;
                    break;
                  }
                }
              }
            } catch (error) {
              console.log('Could not read Claude output files:', error.message);
            }
            
            // Find existing Claude comment to update
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Look for Claude MergeOrchestrator error comment that needs updating (contains "Claude encountered an error")
            const claudeComments = comments.data.filter(comment => 
              comment.body && 
              comment.body.includes('Claude encountered an error') &&
              (
                // Either already has MergeOrchestrator-specific content
                (
                  comment.body.includes('MergeOrchestrator') ||
                  comment.body.includes('Merge Orchestrator') ||
                  comment.body.includes('Final Analysis') ||
                  comment.body.includes('Deployment Decision') ||
                  comment.body.includes('🔍 MergeOrchestrator')
                ) ||
                // Or is a generic error comment that hasn't been updated yet
                (
                  comment.body.includes('I\'ll analyze this and get back to you') &&
                  !comment.body.includes('TestMaster') &&
                  !comment.body.includes('StandardsGuardian') &&
                  !comment.body.includes('DebtSentinel') &&
                  !comment.body.includes('SecuritySentinel')
                )
              )
            );
            // Get the most recent Claude error comment for MergeOrchestrator
            const claudeComment = claudeComments.length > 0 ? claudeComments[claudeComments.length - 1] : null;
            
            const failureCommentBody = isUsageLimitFailure ? 
              `## 🚫 MergeOrchestrator Analysis Failed - Usage Limit Reached
              
              **Analysis Status:** ❌ **FAILED**
              
              The final Merge Orchestrator Analysis could not be completed due to Claude AI usage limit being reached.
              
              **Impact:**
              - This PR cannot receive automated final deployment decision analysis
              - **MANUAL REVIEW REQUIRED** before merging
              - All individual analysis components (testing, standards, tech debt, security) may be unavailable
              
              **Next Steps:**
              - Wait for Claude usage limit to reset (typically resets daily)
              - Re-run the workflow or push a new commit to retry analysis
              - **IMPORTANT**: Manual comprehensive review required for merge decision
              - Review all automated checks (build, tests, security scans) manually
              
              **Workflow Status:** This failure will block the pipeline to ensure proper quality gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*` :
              `## 🚫 MergeOrchestrator Analysis Failed - Technical Error
              
              **Analysis Status:** ❌ **FAILED**
              
              The final Merge Orchestrator Analysis encountered a technical error and could not be completed.
              
              **Impact:**
              - This PR cannot receive automated final deployment decision analysis
              - **MANUAL REVIEW REQUIRED** before merging
              
              **Next Steps:**
              - Check workflow logs for specific error details
              - Re-run the workflow to retry analysis
              - **IMPORTANT**: Manual comprehensive review required for merge decision
              
              **Workflow Status:** This failure will block the pipeline to ensure proper quality gates are maintained.
              
              ---
              *Workflow Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;
            
            if (claudeComment) {
              // Update existing Claude comment
              console.log(`Updating existing Claude comment ID: ${claudeComment.id}`);
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: claudeComment.id,
                body: failureCommentBody
              });
            } else {
              // Fallback: create new comment if Claude comment not found
              console.log('Claude comment not found, creating new comment');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: failureCommentBody
              });
            }
            
            core.setFailed(isUsageLimitFailure ? 
              'MergeOrchestrator analysis failed due to Claude AI usage limit' : 
              'MergeOrchestrator analysis failed due to technical error');

  final-summary:
    name: "Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [path-analysis, backend-build, frontend-build, build-summary, claude-testing-analysis, claude-standards-analysis, claude-tech-debt-analysis, security-scans, claude-security-analysis, claude-merge-orchestrator]
    if: always() && !cancelled()
    timeout-minutes: 5

    steps:
      - name: Generate comprehensive pipeline summary
        run: |
          echo "🚀 Zarichney API - Mega Build Pipeline Summary"
          echo "=============================================="
          echo ""
          echo "**Pipeline Configuration:**"
          echo "  - Trigger: ${{ github.event_name }}"
          echo "  - Branch: ${{ github.head_ref || github.ref_name }}"
          echo "  - Target: ${{ github.event.pull_request.base.ref || 'N/A' }}"
          echo "  - SHA: ${{ github.sha }}"
          echo ""
          
          echo "**Path Analysis:**"
          echo "  - Backend changed: ${{ needs.path-analysis.outputs.backend-changed || 'N/A' }}"
          echo "  - Frontend changed: ${{ needs.path-analysis.outputs.frontend-changed || 'N/A' }}"
          echo "  - Documentation only: ${{ needs.path-analysis.outputs.docs-only || 'N/A' }}"
          echo ""
          
          echo "**Build Results:**"
          echo "  - Backend build: ${{ needs.backend-build.result || 'skipped' }}"
          echo "  - Frontend build: ${{ needs.frontend-build.result || 'skipped' }}"
          echo "  - Build summary: ${{ needs.build-summary.result || 'skipped' }}"
          echo ""
          
          echo "**Quality Analysis Results:**"
          echo "  - Testing Analysis (AI): ${{ needs.claude-testing-analysis.result || 'skipped' }}"
          echo "  - Standards Analysis (AI): ${{ needs.claude-standards-analysis.result || 'skipped' }}"
          echo "  - Tech Debt Analysis (AI): ${{ needs.claude-tech-debt-analysis.result || 'skipped' }}"
          echo ""
          
          echo "**Security Analysis Results:**"
          echo "  - Security scans: ${{ needs.security-scans.result || 'skipped' }}"
          echo "  - Security Analysis (AI): ${{ needs.claude-security-analysis.result || 'skipped' }}"
          echo ""
          
          echo "**Final Analysis Results:**"
          echo "  - Merge Orchestrator (AI): ${{ needs.claude-merge-orchestrator.result || 'skipped' }}"
          echo ""
          
          # Determine overall pipeline status
          FAILED=false
          CRITICAL_FAILED=false
          
          # Check critical build jobs
          if [ "${{ needs.backend-build.result }}" = "failure" ] || [ "${{ needs.frontend-build.result }}" = "failure" ]; then
            CRITICAL_FAILED=true
            FAILED=true
          fi
          
          # Check if security analysis failed (non-critical)
          if [ "${{ needs.security-scans.result }}" = "failure" ]; then
            echo "⚠️  Analysis jobs failed but this does not block the pipeline"
          fi
          
          echo "**Branch-Specific Behavior:**"
          if [ "${{ github.event.pull_request.base.ref }}" = "main" ]; then
            echo "  🔒 Full pipeline with security analysis (PR to main)"
            echo "  🤖 All Claude AI analysis enabled (Testing + Standards + Tech Debt + Security + MergeOrchestrator)"
          elif [ "${{ github.event.pull_request.base.ref }}" = "develop" ]; then
            echo "  📊 Quality analysis pipeline (PR to develop)"
            echo "  🤖 Claude AI analysis enabled (Testing + Standards + Tech Debt + MergeOrchestrator)"
          else
            echo "  🏗️  Build-only pipeline (PR to non-main/develop branch)"
            echo "  🤖 No Claude AI analysis (not targeting main/develop)"
          fi
          echo ""
          
          # Final status determination
          if [ "$CRITICAL_FAILED" = "true" ]; then
            echo "❌ **PIPELINE FAILED**: Critical build failures detected"
            echo "🚫 **ACTION REQUIRED**: Fix build issues before proceeding"
            exit 1
          elif [ "$FAILED" = "true" ]; then
            echo "⚠️  **PIPELINE COMPLETED WITH WARNINGS**: Non-critical issues detected"
            echo "📝 **RECOMMENDED**: Review analysis results and address issues"
          else
            echo "✅ **PIPELINE SUCCEEDED**: All jobs completed successfully"
            if [ "${{ github.event.pull_request.base.ref }}" = "main" ] || [ "${{ github.event.pull_request.base.ref }}" = "develop" ]; then
              echo "🤖 **AI ANALYSIS**: Claude AI feedback available in PR comments"
            fi
            echo "🎉 **READY**: Changes are ready for review and merge"
          fi