# Module/Directory: /Integration/Status

**Last Updated:** 2025-05-19

> **Parent:** [`Integration`](../README.md)
> **Related:**
> * **Status Service Sources:**
>   * [`Services/Status/StatusService.cs`](../../../api-server/Services/Status/StatusService.cs)
>   * [`Services/Status/FeatureAvailabilityMiddleware.cs`](../../../api-server/Services/Status/FeatureAvailabilityMiddleware.cs)
>   * [`Services/Status/ServiceAvailabilityOperationFilter.cs`](../../../api-server/Services/Status/ServiceAvailabilityOperationFilter.cs)
>   * [`Services/Status/ServiceUnavailableException.cs`](../../../api-server/Services/Status/ServiceUnavailableException.cs)
>   * [`Services/Status/RequiresConfigurationAttribute.cs`](../../../api-server/Services/Status/RequiresConfigurationAttribute.cs)
>   * [`Services/Status/DependsOnServiceAttribute.cs`](../../../api-server/Services/Status/DependsOnServiceAttribute.cs)
> * **Startup:** [`Startup/ApplicationStartup.cs`](../../../api-server/Startup/ApplicationStartup.cs)
> * **Standards:** [`TestingStandards.md`](../../../Docs/Standards/TestingStandards.md), [`DocumentationStandards.md`](../../../Docs/Standards/DocumentationStandards.md)
> * **Test Infrastructure:** [`IntegrationTestBase.cs`](../IntegrationTestBase.cs), [`CustomWebApplicationFactory.cs`](../../Framework/Fixtures/CustomWebApplicationFactory.cs)

## 1. Purpose & Responsibility

This directory contains integration tests for verifying the behavior of the API's status and service availability system, including:

* **Status API**: Tests the `/api/status` endpoint to ensure it properly reflects service availability
* **Feature Availability Middleware**: Tests the behavior of `FeatureAvailabilityMiddleware` which prevents access to endpoints when required services are unavailable
* **Swagger Integration**: Tests that Swagger UI documentation correctly shows warnings for endpoints that depend on unavailable services

All these tests collectively validate the system's ability to respond appropriately when services are unavailable due to missing configuration, ensuring proper error responses, API behavior, and documentation.

## 2. Architecture & Key Concepts

### Status Service Testing

The integration tests verify the behavior of the status system in real-world scenarios with a focus on how the API responds to missing configuration:

* **Mock Status Service**: Used to simulate specific service availability scenarios
* **ServiceUnavailableException**: Thrown by the middleware when an endpoint requires unavailable services
* **HTTP 503 Responses**: Verified for endpoints with `[DependsOnService]` attribute when dependencies are unavailable
* **Configuration Reporting**: Tested through the `/api/status` endpoint
* **Swagger Documentation**: Verified to include appropriate warnings for endpoints with unavailable dependencies

The testing strategy relies on controlled mock implementations to verify deterministic outcomes while testing the entire API request pipeline.

## 3. Interface Contract & Assumptions

* **Test Assumptions**:
  * Testing uses a standard `IntegrationTestBase` which provides access to the test server and HTTP clients
  * The `IStatusService` interface is the primary contract for service status and availability
  * The `FeatureAvailabilityMiddleware` relies on `[DependsOnService]` attributes to identify service dependencies
  * Swagger documentation is generated by the `ServiceAvailabilityOperationFilter` based on service availability

* **Critical Test Behaviors**:
  * Endpoints with unavailable dependencies should return HTTP 503 Service Unavailable
  * Swagger documentation should include warnings (⚠️) for endpoints with unavailable dependencies
  * Error responses should include details about missing configuration
  * Status endpoints should correctly report service availability information

## 4. Local Conventions & Constraints

* **Test Organization**:
  * All status-related integration tests are consolidated in this directory
  * Mock configuration used to simulate various service availability scenarios
  * Tests use `CustomWebApplicationFactory` to replace services with mocks when needed
  * Shared test infrastructure from `IntegrationTestBase` and `ApiClientFixture`

* **Middleware Test Specifics**:
  * `FeatureAvailabilityMiddlewareTests` use the test controller in `Framework/TestControllers/FeatureTestController.cs`
  * Mock `IStatusService` instances are injected to simulate service availability state
  * Specific HTTP headers are used to control test client behavior

* **Swagger Test Specifics**:
  * `SwaggerFeatureAvailabilityTests` verify detailed operation filter behavior
  * `SwaggerLiveServiceStatusTests` verify real-world service status in Swagger

## 5. How to Work With This Code

* **Running Tests**:
  * Run all status tests: `dotnet test --filter "FullyQualifiedName~ZarichneyTests.Integration.Status"`
  * Run specific tests: `dotnet test --filter "Name~FeatureAvailabilityMiddleware"`

* **Adding New Tests**:
  * For new feature availability behavior, extend the existing test files or add new ones following the same patterns
  * Use the mock `IStatusService` pattern for controlled testing
  * For external service dependencies, ensure proper test skipping when prerequisites aren't available using `[DependencyFact]`

* **Common Test Issues**:
  * Ensure mock service responses accurately reflect the expected behavior in the real application
  * When testing with real services, handle the case where all services might be available (use `Skip.If` when needed)
  * For Swagger tests, check that the JSON content can be properly deserialized

## 6. Dependencies

* **Test Dependencies**:
  * `Framework/Attributes` - For `[DependencyFact]` and other test attributes
  * `Framework/Fixtures` - For `ApiClientFixture`, `CustomWebApplicationFactory`
  * `Framework/Helpers` - For authentication and configuration helpers
  * `Framework/TestControllers` - For test-specific controller endpoints

* **Production Code Dependencies**:
  * `Services/Status/*` - All status-related components to be tested
  * `Controllers/PublicController.cs` - Contains the status endpoints

## 7. Known Issues & TODOs

## Missing Test Coverage (TODO)

* **StatusService Tests**:
  * TODO: Test `StatusService.GetServiceStatusAsync()` for correctly reporting a mix of available and unavailable services
  * TODO: Test `StatusService.GetFeatureStatus(ExternalServices)` returns accurate information for each enum value
  * TODO: Test `StatusService.IsFeatureAvailable(ExternalServices)` returns correct boolean status for each enum value
  * TODO: Test `StatusService` constructor that accepts an Assembly parameter for improved testability

* **FeatureAvailabilityMiddleware Tests**:
  * TODO: Test caching behavior of `FeatureAvailabilityMiddleware` to ensure performance optimization works
  * TODO: Test endpoint with multiple `[DependsOnService]` attributes (at both controller and action level)
  * TODO: Test handling of nested controllers where parent and child have different service dependencies

* **ServiceAvailabilityOperationFilter Tests**:
  * TODO: Test how the filter handles operations with multiple HTTP methods or complex parameter sets
  * TODO: Test filter behavior for protected/authenticated endpoints requiring authorization

* **Proxy Tests**:
  * TODO: Test all service proxy implementations in `Services/Status/Proxies/` directory:
    * `AudioClientProxy.cs`
    * `GraphServiceClientProxy.cs`
    * `MailCheckClientProxy.cs`
    * `OpenAiClientProxy.cs`

* **Attribute Tests**:
  * TODO: Test `RequiresConfigurationAttribute` with multiple service dependencies
  * TODO: Test `DependsOnServiceAttribute` with multiple service dependencies

* **Configuration Derivation Tests**:
  * TODO: Test automatic derivation of configuration keys from class and property names
  * TODO: Test handling of complex nested configuration structures

## 8. Changelog

* **2025-05-19:** 
  * Consolidated status tests from multiple directories 
  * Added missing test coverage TODOs based on production code review
  * Moved Swagger and Middleware tests to /Status directory
  * Updated all namespaces to ZarichneyTests.Integration.Status