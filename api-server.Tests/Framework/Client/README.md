# README: /Framework/Client Directory

**Version:** 1.2
**Last Updated:** 2025-05-25
**Parent:** `../README.md`

## 1. Purpose & Responsibility

This directory houses **multiple auto-generated Refit client interfaces** and their associated Data Transfer Objects (DTOs) that Refit generates. The interfaces are organized by API tags (corresponding to controllers).

The primary responsibilities of the code within this directory are:
* To provide **type-safe mechanisms for integration tests** to interact with the `api-server`'s HTTP endpoints through granular, controller-specific interfaces.
* To ensure that integration tests are calling the API according to its **current contract** as defined by its OpenAPI (Swagger) specification.
* To maintain a legacy unified interface (`IZarichneyAPI.cs`) for backward compatibility during transition.

These generated clients are critical components for robust integration testing, enabling compile-time checks for API calls and simplifying the process of making requests and deserializing responses.

## 2. Architecture & Key Concepts

* **Refit:** This directory leverages the [Refit](https://github.com/reactiveui/refit) library, which automatically turns REST APIs into live, type-safe C# interfaces.
* **Code Generation:**
    * Multiple interface files (e.g., `IAuthApi.cs`, `IAiApi.cs`, `ICookbookApi.cs`, `IPaymentApi.cs`, `IPublicApi.cs`) and related model classes are **not manually written**.
    * They are generated by the `refitter` tool, which consumes the `swagger.json` (OpenAPI specification) file produced by the `api-server`.
    * Generation is configured via the `Scripts/.refitter` file with settings: `multipleInterfaces: "ByTag"` and `generateMultipleFiles: true`.
    * This generation process is automated by scripts:
        * `../../../../Scripts/generate-api-client.ps1` (for PowerShell)
        * `../../../../Scripts/generate-api-client.sh` (for Bash/Zsh)
    * These scripts perform steps including building the `api-server`, exporting its `swagger.json`, and then running `refitter` to produce the client code in this directory. (See Section 13 of `../../TechnicalDesignDocument.md`).
* **Client Content:** The generated interface files typically include:
    * Individual interface definitions with methods corresponding to each API endpoint grouped by controller/tag.
    * Attributes (from Refit) that define HTTP methods, paths, parameters, and body serialization for each endpoint method.
    * A shared `Contracts.cs` file containing DTO classes used for request bodies and response deserialization.
    * A legacy `IZarichneyAPI.cs` interface maintained for backward compatibility.

## 3. Interface Contract & Assumptions

* **Interface Contract:** The primary "contracts" provided by this module are multiple C# interfaces (e.g., `IAuthApi`, `IAiApi`, `ICookbookApi`, etc.) grouped by API functionality. Integration tests in `../../Integration/` consume these interfaces to make API calls with more granular access to specific API areas.
* **Assumptions:**
    * The generated client interfaces accurately reflect the *current, deployed state* of the `api-server`'s OpenAPI specification at the time of generation.
    * If the API contract of `api-server` changes (e.g., new endpoints, modified DTOs, changed routes or parameters), the clients in this directory **will be outdated** and **must be regenerated** using the provided scripts to avoid runtime errors or incorrect test behavior.

## 4. Local Conventions & Constraints

* **AUTO-GENERATED CODE - DO NOT MANUALLY EDIT:**
    * **CRITICAL:** All C# files within this `/Framework/Client/` directory (including multiple interface files like `IAuthApi.cs`, `IAiApi.cs`, etc., and `Contracts.cs`) are **auto-generated**.
    * **Any manual modifications will be overwritten** the next time the client generation script is run.
    * If changes are needed in the client's structure or behavior, they must be achieved by modifying the `api-server`'s API contract (controllers, DTOs, OpenAPI attributes) and then re-running the generation script.
* **Namespace:** The generated code uses the namespace `Zarichney.Client` as specified in the `TechnicalDesignDocument.md` and configured in the generation scripts.

## 5. How to Work With This Code

### Client Regeneration (Mandatory Task)

* **When:** You **MUST** regenerate the client code using the appropriate script whenever:
    1.  Changes are made to `api-server` API controller signatures (methods, parameters).
    2.  API routes are modified.
    3.  Request or response DTOs used by the API are changed.
    4.  OpenAPI/Swagger generation attributes in `api-server` are updated.
* **How (PowerShell):**
    ```powershell
    ./Scripts/generate-api-client.ps1
    ```
  (Ensure your execution policy allows script execution: `Set-ExecutionPolicy RemoteSigned -Scope Process`)
* **How (Bash/Zsh):**
    ```bash
    ./Scripts/generate-api-client.sh
    ```
  (Ensure the script is executable: `chmod +x ./Scripts/generate-api-client.sh`)
* **Impact:** This ensures that compilation errors will immediately highlight any integration tests that are broken due to API contract changes, rather than discovering these issues at runtime.

### Using the Clients in Integration Tests

* Instances of specific API interfaces (e.g., `IAuthApi`, `IAiApi`, etc.) are typically obtained via the `ApiClientFixture`, which provides both authenticated and unauthenticated versions of each client.
    ```csharp
    // Example within an integration test method:
    // Using the AuthApi for authentication endpoints
    var response = await ApiClient.UnauthenticatedAuthApi.LoginAsync(new LoginRequestDto { /* ... */ });
    response.StatusCode.Should().Be(HttpStatusCode.OK);

    // Using the CookbookApi for cookbook-related endpoints
    var recipes = await ApiClient.AuthenticatedCookbookApi.GetRecipesAsync();
    recipes.Should().NotBeNull();
    ```
* The `ApiClientFixture` provides granular access to different API areas through properties like `AuthenticatedAuthApi`, `UnauthenticatedAiApi`, `AuthenticatedCookbookApi`, etc.
* Refer to `../../../Docs/Standards/IntegrationTestCaseDevelopment.md` for detailed patterns on using the clients.

## 6. Dependencies

### Tooling Dependencies (for Generation)

* **`dotnet swagger` tool:** Used to export the OpenAPI (`swagger.json`) from the `api-server` project.
* **`refitter` tool:** Used to generate the C# client interface from the `swagger.json` file.
* These tools are typically installed as .NET local or global tools.

### Library Dependencies (Runtime)

* **`Refit` (NuGet package):** Required by the `api-server.Tests` project for the generated client code to compile and function.
* **`System.Text.Json` or `Newtonsoft.Json`:** Depending on the serializer configured for Refit (project default is System.Text.Json).

### Source & Consumers

* **Source:** The `api-server` project's compiled output and its generated OpenAPI specification (`swagger.json`).
* **Primary Consumers:** All integration tests located in the `../../Integration/` directory, accessed through the `ApiClientFixture` which provides granular client instances.

## 7. Rationale & Key Historical Context

Generated, type-safe Refit clients organized by API functionality were chosen for several key reasons:
* **Type Safety:** Eliminates errors related to incorrect URLs, HTTP methods, parameter names, or DTO structures at compile time.
* **Ease of Use:** Simplifies making API calls from test code, making tests cleaner and easier to write and understand.
* **Direct Contract Linkage:** Ensures tests are tightly coupled to the API's defined contract. Changes in the API that break the contract will result in client generation that fails to compile or causes test compilation failures, providing immediate feedback.
* **Granular Access:** Multiple interfaces allow tests to focus on specific API areas (Auth, AI, Cookbook, etc.) rather than working with a monolithic interface.
* **Reduced Boilerplate:** Avoids manual `HttpClient` setup and JSON serialization/deserialization logic in numerous tests.

This approach is central to maintaining a robust and reliable integration test suite that accurately reflects the API's behavior while providing organized, granular access to different API functionalities.

## 8. Known Issues & TODOs

* **Generation Script Failures:** If the `api-server` fails to build or its Swagger generation fails, the client generation scripts will also fail. The root cause in `api-server` must be addressed first.
* **OpenAPI Specification Accuracy:** The quality of the generated clients depends entirely on the accuracy and completeness of the `api-server`'s OpenAPI specification. Any inaccuracies in the Swagger output will be reflected in the clients.
* **Manual DTO Definitions:** Currently, `refitter` generates DTOs used by the clients in the shared `Contracts.cs` file. If these DTOs were to be shared directly from a common project with `api-server`, the `refitter` configuration might need adjustment to prevent re-declaration. (No current plans for this).

---
