# Module/Directory: /Services/PdfGeneration

**Last Updated:** 2025-04-03

> **Parent:** [`/Services`](../README.md)

## 1. Purpose & Responsibility

* **What it is:** This module is responsible for generating PDF documents, specifically compiling personalized cookbooks from processed recipe data.
* **Key Responsibilities:**
    * Defining the `PdfCompiler` service responsible for the PDF generation logic. [cite: api-server/Services/PdfCompiler.cs]
    * Defining configuration (`PdfCompilerConfig`) for PDF generation settings like fonts and temporary directories. [cite: api-server/Services/PdfCompiler.cs]
    * Taking a `CookbookOrder` object (containing `SynthesizedRecipe` data) as input. [cite: api-server/Cookbook/Orders/OrderModels.cs]
    * Parsing Markdown content within recipes using the `Markdig` library. [cite: api-server/Services/PdfCompiler.cs]
    * Processing and embedding images referenced in recipes, including fetching, resizing (using `SixLabors.ImageSharp`), and temporary storage (using `IFileService`). [cite: api-server/Services/PdfCompiler.cs]
    * Defining the layout, styling, and structure of the final PDF document using the `QuestPDF` library. [cite: api-server/Services/PdfCompiler.cs]
    * Handling page setup, headers, footers, and pagination.
* **Why it exists:** To encapsulate the complex logic required to transform structured application data (cookbook orders and recipes, including Markdown) into a well-formatted, distributable PDF file.

## 2. Architecture & Key Concepts

* **Core Component:** The `PdfCompiler` class contains the main logic for PDF generation. [cite: api-server/Services/PdfCompiler.cs]
* **PDF Library:** Uses the `QuestPDF` library, leveraging its fluent API to define document structure (pages, columns, containers, text, images). [cite: api-server/Services/PdfCompiler.cs]
* **Markdown Parsing:** Employs the `Markdig` library to parse Markdown content generated by `SynthesizedRecipe.ToMarkdown()`. [cite: api-server/Services/PdfCompiler.cs]
* **Custom PDF Component:** Includes an internal nested class `RecipeComponent : IComponent` (QuestPDF component interface) that defines how individual recipes (parsed from Markdown) are rendered within the PDF, handling different Markdown elements like headings, lists, paragraphs, and images. [cite: api-server/Services/PdfCompiler.cs]
* **Image Handling:** Fetches images from URLs (including data URLs), resizes them using `SixLabors.ImageSharp` to fit layout constraints, saves them temporarily using `IFileService`, embeds them in the PDF, and attempts cleanup afterwards. [cite: api-server/Services/PdfCompiler.cs]
* **Configuration:** Driven by `PdfCompilerConfig` for font settings (name, size) and the temporary directory path for image processing. [cite: api-server/Services/PdfCompiler.cs]
* **Input:** The primary input is a `CookbookOrder` object containing a list of `SynthesizedRecipe` objects. [cite: api-server/Cookbook/Orders/OrderModels.cs]

## 3. Interface Contract & Assumptions

* **Key Public Interfaces:** The `PdfCompiler` class itself and its `CompileCookbook(CookbookOrder order)` method, which returns the generated PDF as a `byte[]`.
* **Assumptions:**
    * **Library Functionality:** Assumes `QuestPDF`, `Markdig`, and `SixLabors.ImageSharp` libraries function correctly.
    * **Input Data Validity:** Assumes the input `CookbookOrder` and its `SynthesizedRecipe` list are valid. Assumes `recipe.ToMarkdown()` produces Markdown compatible with the `Markdig` parser and the rendering logic in `RecipeComponent`.
    * **Image Accessibility:** Assumes image URLs (`recipe.ImageUrls`) are accessible via HTTP/HTTPS or are valid data URLs. Assumes the image data is in a format supported by `SixLabors.ImageSharp`. [cite: api-server/Services/PdfCompiler.cs]
    * **File System Access:** Assumes `IFileService` is functional and the application has write/delete permissions for the temporary directory specified in `PdfCompilerConfig.ImageDirectory`. [cite: api-server/Services/PdfCompiler.cs]
    * **Font Availability:** Assumes the font specified in `PdfCompilerConfig.FontName` is available on the server environment where the PDF generation occurs.

## 4. Local Conventions & Constraints (Beyond Global Standards)

* **Technology Stack:** Relies specifically on `QuestPDF` for generation, `Markdig` for Markdown parsing, and `SixLabors.ImageSharp` for image manipulation.
* **Markdown Support:** PDF rendering support is limited to the Markdown elements handled within the `RecipeComponent` (headings, paragraphs, lists, tables, images, thematic breaks). Other Markdown features might not render correctly. [cite: api-server/Services/PdfCompiler.cs]
* **Image Processing:** Specific resizing logic (max width/height) is implemented within `ProcessImage`. Temporary images are created during processing. [cite: api-server/Services/PdfCompiler.cs]
* **Configuration:** Requires the `PdfCompilerConfig` section in application configuration. [cite: api-server/appsettings.json]

## 5. How to Work With This Code

* **Consumption:** Inject `PdfCompiler` and call `CompileCookbook(order)` method.
* **Modifying Layout/Style:** Changes to the overall PDF structure, page setup, or recipe styling require modifying the `QuestPDF` fluent API calls within `PdfCompiler.GeneratePdf` and the `RecipeComponent.Compose` method. [cite: api-server/Services/PdfCompiler.cs]
* **Modifying Markdown Rendering:** Adjustments to how specific Markdown elements are rendered into PDF elements are made within the `RecipeComponent.Render*` methods (e.g., `RenderHeading`, `RenderList`). [cite: api-server/Services/PdfCompiler.cs]
* **Testing:**
    * Unit testing typically involves mocking `IFileService` and providing test `CookbookOrder` data. Asserting the output `byte[]` directly is difficult.
    * Verification often requires saving the output `byte[]` to a `.pdf` file and performing manual visual inspection or using specialized PDF comparison/testing tools.
* **Common Pitfalls / Gotchas:** Layout issues caused by complex QuestPDF configurations. Errors during Markdown parsing (`Markdig`). Errors fetching or processing images (invalid URLs, unsupported formats, network issues, file permissions for temp dir). Font not found errors. Performance degradation with extremely large documents or numerous high-resolution images. Temporary image files not being cleaned up correctly if `IFileService.DeleteFile` fails.

## 6. Dependencies

* **Internal Code Dependencies:**
    * [`/Config`](../../Config/README.md): Consumes `PdfCompilerConfig`.
    * [`/Services/FileSystem`](../FileSystem/README.md): Consumes `IFileService` for image handling.
    * [`/Cookbook/Orders`](../../Cookbook/Orders/README.md): Uses `CookbookOrder` model.
    * [`/Cookbook/Recipes`](../../Cookbook/Recipes/README.md): Uses `SynthesizedRecipe` model and its `ToMarkdown()` output.
    * [`/Services/Utils.cs`](../Utils.cs): Uses helper methods.
* **External Library Dependencies:**
    * `QuestPDF`: Core PDF generation library.
    * `Markdig`: Markdown parsing library.
    * `SixLabors.ImageSharp`: Image processing library.
* **Dependents (Impact of Changes):**
    * [`/Cookbook/Orders/OrderService.cs`](../../Cookbook/Orders/OrderService.cs): Consumes `PdfCompiler` to generate the final cookbook PDF.
    * `Program.cs`: Registers `PdfCompiler` service.

## 7. Rationale & Key Historical Context

* **Programmatic PDF Generation:** `QuestPDF` was chosen for its code-centric, fluent API approach to defining PDF documents directly in C#, avoiding the need for external templates or report designers.
* **Markdown Integration:** `Markdig` allows leveraging Markdown generated from recipe data for content within the PDF, simplifying content creation.
* **Cross-Platform Image Processing:** `SixLabors.ImageSharp` provides image manipulation capabilities without native dependencies, suitable for cross-platform deployment.
* **Centralization:** Consolidates the complex task of PDF generation from application data into a dedicated service.

## 8. Known Issues & TODOs

* Currently processes only the first valid image URL found in `SynthesizedRecipe.ImageUrls`; could be enhanced to support multiple images per recipe or provide image selection logic. [cite: api-server/Services/PdfCompiler.cs]
* The robustness of temporary image file cleanup depends on the reliability of `IFileService.DeleteFile`.
* Performance for generating very large cookbooks (many recipes, large images) has not been profiled.
* Layout defined in `RecipeComponent` might need refinement for complex or unusually formatted recipe Markdown.
* Font handling relies on the font being available in the execution environment; embedding fonts could improve portability but increase file size.